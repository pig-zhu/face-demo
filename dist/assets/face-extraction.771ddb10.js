import{n as m,l as j,M as E,T as b,S as _,u as M,k as D}from"./FaceMatcher.94dbf9cd.js";import{d as L}from"./drawDetections.cb76136a.js";import{b as U}from"./bufferToImage.0eb741dc.js";import{m as v,d as w,r as T}from"./resizeResults.b26e0a3c.js";import{_ as R}from"./index.26d86ee2.js";import{d as S,y as x,r as o,x as $,E as s,f as a,w as c,F as z,o as B,G as O,H as N,I as h}from"./vendor.43a23b66.js";const V=S({name:"face-extraction",data(){return{showModal:!0,showLoading:!1,checked:!1,minConfidence:.5,scoreThreshold:.5,inputSize:512,imgUrl:"",fileList:[],selectvalue:"bbt1.jpg",facevalue:"ssdMobilenetv1",drawImg:"/images/bbt1.jpg",defaultImgs:[{label:"bbt1.jpg",value:"bbt1.jpg"},{label:"bbt2.jpg",value:"bbt2.jpg"},{label:"bbt3.jpg",value:"bbt3.jpg"},{label:"bbt4.jpg",value:"bbt4.jpg"},{label:"bbt5.jpg",value:"bbt5.jpg"}],faces:[{label:"SSD Mobilenet V1",value:"ssdMobilenetv1"},{label:"Tiny Face Detector",value:"tinyFaceDetector"}],options:null,inputImgEl:null,canvas:null,facesContainer:null}},watch:{selectvalue(e){this.drawImg=`public/images/${e}`,setTimeout(()=>{this.updateResults()},0)},facevalue(e){this.fnInit(),this.updateResults()}},mounted(){this.$nextTick(()=>{this.fnInit().then(()=>this.updateResults())}),this.$message=x(),this.inputImgEl=document.getElementById("inputImg"),this.facesContainer=document.getElementById("facesContainer"),this.canvas=document.getElementById("overlay")},methods:{async fnInit(){switch(this.showLoading=!0,await m[this.facevalue].loadFromUri("/models"),await j("/models"),this.facevalue){case"ssdMobilenetv1":this.options=new _({minConfidence:.5});break;case"tinyFaceDetector":this.options=new b({inputSize:512,scoreThreshold:.5});break;case"mtcnn":this.options=new E({minFaceSize:20,scaleFactor:.709});break}this.showLoading=!1},handleChange({event:e,file:t,fileList:n}){this.drawImg=URL.createObjectURL(t.file),this.updateResults(),this.fileList=n},handleUpdateChecked(e){this.checked=e,this.updateResults()},async clickConfirm(){if(this.imgUrl){let e=await this.requestExternalImage(this.imgUrl);this.drawImg=e.src,this.updateResults()}},getCurrentFaceDetectionNet(){if(this.facevalue==="ssdMobilenetv1")return m.ssdMobilenetv1;if(this.facevalue==="tinyFaceDetector")return m.tinyFaceDetector},isFaceDetectionModelLoaded(){return!!this.getCurrentFaceDetectionNet().params},getFaceDetectorOptions(){return this.facevalue==="ssdMobilenetv1"?new _({minConfidence:this.minConfidence}):new b({inputSize:this.inputSize,scoreThreshold:this.scoreThreshold})},async requestExternalImage(e){let t=await fetch(e);try{let n=await t.blob();return await U(n)}catch{throw new Error("failed to load image from url: "+e)}},displayExtractedFaces(e){const{canvas:t,inputImgEl:n,facesContainer:r}=this;v(t,n),r.innerHTML="",e.forEach(u=>{u.style.margin="10px",r.append(u)})},async updateResults(){if(!this.isFaceDetectionModelLoaded())return;const{canvas:e,inputImgEl:t}=this;e.getContext("2d").clearRect(0,0,e.width,e.height);const n=this.getFaceDetectorOptions(),r=await w(t,n),u=await M(t,r);this.displayExtractedFaces(u);const f=await w(t,n).withFaceLandmarks();e.width=t.width,e.height=t.height,v(e,t);let d=T(f,t);d.length?(this.checked||L(e,d),D(e,d)):this.$message.error("\u8FD9\u53EF\u80FD\u4E0D\u662F\u4E2A\u4EBA\uFF01")}}}),i=e=>(O("data-v-399fc8be"),e=e(),N(),e),q={style:{position:"relative"},class:"margin"},H={style:{width:"300px","margin-right":"10px"}},A=i(()=>s("h4",null,"\u56FE\u7247\u8F93\u5165",-1)),G=i(()=>s("label",{for:""},"\u9009\u62E9\u4E00\u4E2A\u7167\u7247\u5427\uFF1A",-1)),J=h("\u6216\u8005"),K=i(()=>s("label",{for:""},"\u8F93\u5165\u4E00\u4E2A\u56FE\u7247\u94FE\u63A5\uFF1A",-1)),P=h("\u786E\u5B9A"),Q=h("\u6216\u8005"),W=i(()=>s("label",{for:""},"\u4ECE\u672C\u5730\u9009\u4E00\u5F20\u56FE\u7247\uFF1A",-1)),X=h("\u9009\u62E9\u6587\u4EF6"),Y=i(()=>s("h4",null,"\u9009\u62E9\u4EBA\u8138\u68C0\u6D4B\u5668",-1)),Z={style:{position:"relative"}},ee=["src"],te=i(()=>s("canvas",{id:"overlay"},null,-1)),se=i(()=>s("div",{id:"facesContainer"},null,-1)),ae=i(()=>s("div",{class:"loader"},"\u52A0\u8F7D\u4E2D...",-1));function ne(e,t,n,r,u,f){const d=o("n-select"),p=o("n-divider"),I=o("n-input"),g=o("n-button"),y=o("n-upload"),C=o("n-checkbox"),F=o("n-space"),k=o("n-modal");return B(),$(z,null,[s("div",q,[a(F,null,{default:c(()=>[s("div",H,[A,G,a(d,{value:e.selectvalue,"onUpdate:value":t[0]||(t[0]=l=>e.selectvalue=l),options:e.defaultImgs},null,8,["value","options"]),a(p,{"title-placement":"left"},{default:c(()=>[J]),_:1}),K,a(I,{value:e.imgUrl,"onUpdate:value":t[1]||(t[1]=l=>e.imgUrl=l),type:"text",placeholder:"\u56FE\u7247\u94FE\u63A5"},null,8,["value"]),a(g,{onClick:e.clickConfirm},{default:c(()=>[P]),_:1},8,["onClick"]),a(p,{"title-placement":"left"},{default:c(()=>[Q]),_:1}),W,a(y,{onChange:e.handleChange,"default-upload":!1,ref:"upload"},{default:c(()=>[a(g,null,{default:c(()=>[X]),_:1})]),_:1},8,["onChange"]),a(p,{"title-placement":"left"}),Y,a(d,{value:e.facevalue,"onUpdate:value":t[2]||(t[2]=l=>e.facevalue=l),options:e.faces},null,8,["value","options"]),a(C,{style:{"margin-top":"10px"},"onUpdate:checked":e.handleUpdateChecked,label:"\u9690\u85CF\u8FB9\u754C\u6846"},null,8,["onUpdate:checked"])]),s("div",Z,[s("img",{id:"inputImg",style:{width:"100%",border:"0"},src:e.drawImg},null,8,ee),te,se])]),_:1})]),a(k,{show:e.showLoading,"onUpdate:show":t[3]||(t[3]=l=>e.showLoading=l)},{default:c(()=>[ae]),_:1},8,["show"])],64)}var ue=R(V,[["render",ne],["__scopeId","data-v-399fc8be"]]);export{ue as default};
