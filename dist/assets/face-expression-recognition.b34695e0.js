import{defineComponent as I,resolveComponent as l,openBlock as E,createElementBlock as D,Fragment as j,createElementVNode as a,createVNode as o,withCtx as r,pushScopeId as x,popScopeId as C,createTextVNode as g}from"vue";import{e as M,f as k,i as L,P as R,g as T,a as S,n as _,l as U,h as $,M as z,T as w,S as y,b as O,d as A,m as N,r as B}from"./resizeResults.d064f547.js";import{d as V}from"./drawDetections.ca78c1c6.js";import{_ as W}from"./index.31beede5.js";import{u as q}from"./vendor.464b1a6c.js";function P(e,t,s,m){s===void 0&&(s=.1);var d=Array.isArray(t)?t:[t];d.forEach(function(n){var p=n instanceof M?n:k(n)?n.expressions:void 0;if(!p)throw new Error("drawFaceExpressions - expected faceExpressions to be FaceExpressions | WithFaceExpressions<{}> or array thereof");var h=p.asSortedArray(),v=h.filter(function(u){return u.probability>s}),f=L(n)?n.detection.box.bottomLeft:m||new R(0,0),b=new T(v.map(function(u){return u.expression+" ("+S(u.probability)+")"}),f);b.draw(e)})}const G=I({name:"face-expression-recognition",data(){return{showModal:!0,showLoading:!1,checked:!1,minConfidence:.5,scoreThreshold:.5,inputSize:512,imgUrl:"",fileList:[],selectvalue:"bbt1.jpg",facevalue:"ssdMobilenetv1",drawImg:"/images/bbt1.jpg",defaultImgs:[{label:"bbt1.jpg",value:"bbt1.jpg"},{label:"bbt2.jpg",value:"bbt2.jpg"},{label:"bbt3.jpg",value:"bbt3.jpg"},{label:"bbt4.jpg",value:"bbt4.jpg"},{label:"bbt5.jpg",value:"bbt5.jpg"}],faces:[{label:"SSD Mobilenet V1",value:"ssdMobilenetv1"},{label:"Tiny Face Detector",value:"tinyFaceDetector"}],options:null,inputImgEl:null,canvas:null}},watch:{selectvalue(e){this.drawImg=`public/images/${e}`,setTimeout(()=>{this.updateResults()},0)},facevalue(e){this.fnInit(),this.updateResults()}},mounted(){this.$nextTick(()=>{this.fnInit().then(()=>this.updateResults())}),this.$message=q(),this.inputImgEl=document.getElementById("inputImg"),this.canvas=document.getElementById("overlay")},methods:{async fnInit(){switch(this.showLoading=!0,await _[this.facevalue].loadFromUri("/models"),await U("/models"),await $("/models"),this.facevalue){case"ssdMobilenetv1":this.options=new y({minConfidence:.5});break;case"tinyFaceDetector":this.options=new w({inputSize:512,scoreThreshold:.5});break;case"mtcnn":this.options=new z({minFaceSize:20,scaleFactor:.709});break}this.showLoading=!1},handleChange({event:e,file:t,fileList:s}){this.drawImg=URL.createObjectURL(t.file),this.updateResults(),this.fileList=s},handleUpdateChecked(e){this.checked=e,this.updateResults()},async clickConfirm(){if(this.imgUrl){let e=await this.requestExternalImage(this.imgUrl);this.drawImg=e.src,this.updateResults()}},getCurrentFaceDetectionNet(){if(this.facevalue==="ssdMobilenetv1")return _.ssdMobilenetv1;if(this.facevalue==="tinyFaceDetector")return _.tinyFaceDetector},isFaceDetectionModelLoaded(){return!!this.getCurrentFaceDetectionNet().params},getFaceDetectorOptions(){return this.facevalue==="ssdMobilenetv1"?new y({minConfidence:this.minConfidence}):new w({inputSize:this.inputSize,scoreThreshold:this.scoreThreshold})},async requestExternalImage(e){let t=await fetch(e);try{let s=await t.blob();return await O(s)}catch{throw new Error("failed to load image from url: "+e)}},async updateResults(){if(!this.isFaceDetectionModelLoaded())return;const{canvas:e,inputImgEl:t}=this;e.getContext("2d").clearRect(0,0,e.width,e.height);const s=this.getFaceDetectorOptions(),m=await A(t,s).withFaceLandmarks().withFaceExpressions();e.width=t.width,e.height=t.height,N(e,t);let d=B(m,t);d.length?(V(e,d),P(e,d,.05)):this.$message.error("\u8FD9\u53EF\u80FD\u4E0D\u662F\u4E2A\u4EBA\uFF01")}}}),c=e=>(x("data-v-1c98c591"),e=e(),C(),e),H={style:{position:"relative"},class:"margin"},J={style:{width:"300px","margin-right":"10px"}},K=c(()=>a("h4",null,"\u56FE\u7247\u8F93\u5165",-1)),Q=c(()=>a("label",{for:""},"\u9009\u62E9\u4E00\u4E2A\u7167\u7247\u5427\uFF1A",-1)),X=g("\u6216\u8005"),Y=c(()=>a("label",{for:""},"\u8F93\u5165\u4E00\u4E2A\u56FE\u7247\u94FE\u63A5\uFF1A",-1)),Z=g("\u786E\u5B9A"),ee=g("\u6216\u8005"),te=c(()=>a("label",{for:""},"\u4ECE\u672C\u5730\u9009\u4E00\u5F20\u56FE\u7247\uFF1A",-1)),se=g("\u9009\u62E9\u6587\u4EF6"),ae=c(()=>a("h4",null,"\u9009\u62E9\u4EBA\u8138\u68C0\u6D4B\u5668",-1)),oe={style:{position:"relative"}},ne=["src"],ie=c(()=>a("canvas",{id:"overlay"},null,-1)),le=c(()=>a("div",{class:"loader"},"\u52A0\u8F7D\u4E2D...",-1));function re(e,t,s,m,d,n){const p=l("n-select"),h=l("n-divider"),v=l("n-input"),f=l("n-button"),b=l("n-upload"),u=l("n-space"),F=l("n-modal");return E(),D(j,null,[a("div",H,[o(u,{justify:"space-between"},{default:r(()=>[a("div",J,[K,Q,o(p,{value:e.selectvalue,"onUpdate:value":t[0]||(t[0]=i=>e.selectvalue=i),options:e.defaultImgs},null,8,["value","options"]),o(h,{"title-placement":"left"},{default:r(()=>[X]),_:1}),Y,o(v,{value:e.imgUrl,"onUpdate:value":t[1]||(t[1]=i=>e.imgUrl=i),type:"text",placeholder:"\u56FE\u7247\u94FE\u63A5"},null,8,["value"]),o(f,{onClick:e.clickConfirm},{default:r(()=>[Z]),_:1},8,["onClick"]),o(h,{"title-placement":"left"},{default:r(()=>[ee]),_:1}),te,o(b,{onChange:e.handleChange,"default-upload":!1,ref:"upload"},{default:r(()=>[o(f,null,{default:r(()=>[se]),_:1})]),_:1},8,["onChange"]),o(h,{"title-placement":"left"}),ae,o(p,{value:e.facevalue,"onUpdate:value":t[2]||(t[2]=i=>e.facevalue=i),options:e.faces},null,8,["value","options"])]),a("div",oe,[a("img",{id:"inputImg",style:{width:"100%",border:"0"},src:e.drawImg},null,8,ne),ie])]),_:1})]),o(F,{show:e.showLoading,"onUpdate:show":t[3]||(t[3]=i=>e.showLoading=i)},{default:r(()=>[le]),_:1},8,["show"])],64)}var me=W(G,[["render",re],["__scopeId","data-v-1c98c591"]]);export{me as default};
